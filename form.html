<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login / Register</title>
</head>

<body>
    <!-- Login Form -->
    <div id="loginForm">
        <h2>Login</h2>
        <form id="loginFormElement">
            <input type="text" name="username" placeholder="Username" required>
            <br>
            <input type="password" name="password" placeholder="Password" required>
            <br>
            <button type="submit">Login</button>
        </form>
        <p>
            Don't have an account? <a href="#" onclick="showRegister(); return false;">Sign up</a>
        </p>
    </div>

    <!-- Register Form -->
    <div id="registerForm" style="display: none;">
        <h2>Register</h2>
        <form id="registerFormElement">
            <input type="text" name="username" placeholder="Username" required>
            <br>
            <input type="password" name="password" placeholder="Password" required>
            <br>
            <button type="submit">Register</button>
        </form>
        <p>
            Already have an account? <a href="#" onclick="showLogin(); return false;">Login</a>
        </p>
    </div>

    <!-- Response Message -->
    <div id="response"></div>

    <script>
        // Show Register Form
        function showRegister() {
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('registerForm').style.display = 'block';
            document.getElementById('response').innerHTML = '';
        }

        // Show Login Form
        function showLogin() {
            document.getElementById('registerForm').style.display = 'none';
            document.getElementById('loginForm').style.display = 'block';
            document.getElementById('response').innerHTML = '';
        }

        // Handle Login Form Submission
        document.getElementById('loginFormElement').addEventListener('submit', async (e) => {
            e.preventDefault();

            const formData = new FormData(e.target);
            const data = {
                username: formData.get('username'),
                password: formData.get('password')
            };

            await handleSubmit('/api/auth/login', data, e.target);
        });

        // Handle Register Form Submission
        document.getElementById('registerFormElement').addEventListener('submit', async (e) => {
            e.preventDefault();

            const formData = new FormData(e.target);
            const data = {
                username: formData.get('username'),
                password: formData.get('password')
            };

            await handleSubmit('/api/auth/register', data, e.target);
        });

        // Common function to handle form submission
        async function handleSubmit(url, data, formElement) {
            const responseDiv = document.getElementById('response');

            try {
                console.log('http://localhost:8000' + url);
                const response = await fetch('http://localhost:8000' + url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                // Check if response has content before parsing JSON
                const text = await response.text();
                let result;

                try {
                    result = text ? JSON.parse(text) : {};
                } catch (e) {
                    throw new Error('Server returned invalid response');
                }

                if (response.ok) {
                    responseDiv.style.color = 'green';
                    responseDiv.textContent = result.message || 'Success!';
                    formElement.reset();
                } else {
                    responseDiv.style.color = 'red';
                    responseDiv.textContent = result.message || 'An error occurred';
                }
            } catch (error) {
                responseDiv.style.color = 'red';
                responseDiv.textContent = 'Network error: ' + error.message;
            }
        }
    </script>
</body>

</html>